<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Students</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
    <style>
        .btn-bd-primary {
            background-color: rgb(39, 160, 39);
            color: #fff;
        }

        .btn-bd-primary:hover {
            background-color: rgb(29, 121, 29);
            color: #fff;
        }

        .btn-bd-primary:active {
            background-color: rgb(21, 88, 21) !important;
            color: #fff !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Student Records</h1>
        <div class="row justify-content-between">
            <div class="col-6">
                <input type="search" id="searchInput" class="form-control" placeholder="Search by name">
            </div>
            <div class="col-3 ">
                <button class="btn btn-bd-primary" data-bs-toggle="modal" data-bs-target="#add-student-modal">Add
                    Student</button>
                <button class="btn btn-primary" onclick="fetchStudents()">Refresh</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>
        <table class="table mt-3 table-bordered">
            <thead class="table-dark">
                <tr>
                    <th class="col">Profile</th>
                    <th class="col">First Name</th>
                    <th class="col">Last Name</th>
                    <th class="col">Gmail</th>
                    <th class="col">Phone</th>
                    <th class="col">Gender</th>
                    <th class="col">Action</th>
                </tr>
            </thead>
            <tbody id="tbody">

            </tbody>
        </table>
        <nav>
            <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
    </div>

    <!-- add new student modal -->
    <div class="modal fade" tabindex="-1" id="add-student-modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm" enctype="multipart/form-data">
                        <input type="text" class="form-control mt-3" placeholder="First Name" name="first_name">
                        <input type="text" class="form-control mt-3" placeholder="Last Name" name="last_name">
                        <input type="email" class="form-control mt-3" placeholder="Email" name="email">
                        <input type="text" class="form-control mt-3" placeholder="Phone No." name="phone">
                        <select name="gender" class="form-control mt-3" id="gender">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                        <label class="form-label mt-3" for="profile_pic">Upload Profile Pic</label>
                        <input class="form-control" type="file" name="profile_pic">
                        <div class="modal-footer">
                            <input type="submit" value="Create Student" class="btn btn-outline-success">
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- view student modal -->
    <div class="modal fade" tabindex="-1" id="view-student-modal">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Student Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <img id="view_student_img" src="" alt="" width="150" />
                    <p><Strong>Name:</Strong> <span id="viewName"></span></p>
                    <p><Strong>Email:</Strong> <span id="viewEmail"></span></p>
                    <p><Strong>Phone:</Strong> <span id="viewPhone"></span></p>
                    <p><Strong>Gender:</Strong> <span id="viewGender"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- edit student modal -->
    <div class="modal fade" tabindex="-1" id="edit-student-modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm" enctype="multipart/form-data">
                        <input type="hidden" name="studentId" id="studentId" value="">
                        <input type="text" class="form-control mt-3" placeholder="First Name" id="editFirstName"
                            name="first_name">
                        <input type="text" class="form-control mt-3" placeholder="Last Name" id="editLastName"
                            name="last_name">
                        <input type="email" class="form-control mt-3" placeholder="Email" id="editEmail" name="email">
                        <input type="text" class="form-control mt-3" placeholder="Phone No." id="editPhone"
                            name="phone">
                        <select name="gender" class="form-control mt-3" id="editGender">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                        <label class="form-label mt-3" for="profile_pic">Upload Profile Pic</label>
                        <input class="form-control" type="file" id="editProfilePic" name="profile_pic">
                        <div class="modal-footer">
                            <input type="submit" value="Create Student" class="btn btn-outline-success">
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js
"></script>
    <script>

        const apiUrl = 'https://student-data-api-2jng.onrender.com/api/students'
        let currentPage =  1
        let currrentSearch = ''

        function checkAuth(){
            const token = localStorage.getItem('token')
            if(!token){
                window.location.href='/index.html'
            }
            return token
        }
        const token = checkAuth()

        // fetching all students data
        async function fetchStudents(search = '',page=1) {
            const limit = 4
            currentPage = page
            currrentSearch =search
            const res = await fetch(`${apiUrl}?search=${encodeURIComponent(search)}&limit=${limit}&page=${currentPage}`,{
                headers:{'Authorization':`Bearer ${token}`}
            })
            const data = await res.json()
            console.log(data)

            const tbody = document.querySelector('#tbody')
            tbody.innerHTML = ''
            data.students.forEach(student => {
                tbody.innerHTML += `
                <tr class='align-middle'>
                    <td><img src="https://student-data-api-2jng.onrender.com/uploads/${student.profile_pic}" width="50" height='50' class='rounded-5' /></td>
                    <td>${student.first_name}</td>
                    <td>${student.last_name}</td>
                    <td>${student.email}</td>
                    <td>${student.phone}</td>
                    <td>${student.gender}</td>
                    <td>
                        <button class="btn btn-outline-info" data-bs-toggle="modal"
                            data-bs-target="#view-student-modal" onclick="viewStudent('${student._id}')">View</button>
                        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#edit-student-modal" onclick="editStudent('${student._id}')">Edit</button>
                        <button class="btn btn-outline-danger" onclick="deleteStudent('${student._id}')">Delete</button>
                    </td>
                </tr>
                `
            });
            renderPagination(limit, currentPage)

            //rendering pagination function
            function renderPagination(limit, currentPage) {
                const totalPage = data.totalPages
                const pagination = document.querySelector('#pagination')
                pagination.innerHTML = ''

                //prev page
                const prevPage = document.createElement('li')
                    prevPage.innerHTML=`<a class="page-link" href="#">Prev</a>`
                    prevPage.className = 'page-item' + (currentPage == 1? ' disabled':'')
                    prevPage.addEventListener('click',(e)=>{
                        e.preventDefault()
                        if(!(currentPage==1)){
                            fetchStudents(currrentSearch,currentPage-1)
                        }
                    })
                    pagination.appendChild(prevPage)

                for(let i = 1; i<=totalPage; i++){
                    const li = document.createElement('li')
                    li.innerHTML=`<a class="page-link" href="#">${i}</a>`
                    li.className = i == currentPage? ' active':''
                    li.addEventListener('click',(e)=>{
                        e.preventDefault()
                        fetchStudents(currrentSearch,i)
                    })
                    pagination.appendChild(li)
                }

                //next page
                const nextPage = document.createElement('li')
                    nextPage.innerHTML=`<a class="page-link" href="#">Next</a>`
                    nextPage.className = 'page-item' + (currentPage == totalPage? ' disabled':'')
                    nextPage.addEventListener('click',(e)=>{
                        e.preventDefault()
                        if(!(currentPage==data.totalPages)){
                            fetchStudents(currrentSearch,currentPage+1)
                        }
                    })
                    pagination.appendChild(nextPage)
                
            }
        }
        fetchStudents()

        //fetching single student data
        async function viewStudent(id) {
            const res = await fetch(`${apiUrl}/${id}`,{
                headers:{'Authorization':`Bearer ${token}`}
            })
            const student = await res.json()
            console.log(student)

            document.querySelector('#view_student_img').src = `https://student-data-api-2jng.onrender.com/uploads/${student.profile_pic}`
            document.querySelector('#viewName').innerHTML = `${student.first_name} ${student.last_name}`
            document.querySelector('#viewEmail').innerHTML = `${student.email}`
            document.querySelector('#viewPhone').innerHTML = `${student.phone}`
            document.querySelector('#viewGender').innerHTML = `${student.gender}`

        }

        // search student by name
        document.querySelector('#searchInput').addEventListener('input', () => {
            currentPage = 1
            fetchStudents(document.querySelector('#searchInput').value,currentPage)
        })

        //add new student record
        document.querySelector('#addStudentForm').addEventListener('submit', async function (e) {
            e.preventDefault()

            const formData = new FormData(this)
            const res = await fetch(`${apiUrl}`, {
                method: 'POST',
                headers:{'Authorization':`Bearer ${token}`},
                body: formData
            })

            if (res.ok) {
                this.reset()
                bootstrap.Modal.getInstance(document.getElementById('add-student-modal')).hide()
                fetchStudents()
            } else {
                alert('Error to creating student.')
            }

        })

        //edit student modal
        async function editStudent(id) {
            const res = await fetch(`${apiUrl}/${id}`,{
                headers:{'Authorization':`Bearer ${token}`}
            })
            const student = await res.json()

            document.querySelector('#studentId').value = student._id
            document.querySelector('#editFirstName').value = student.first_name
            document.querySelector('#editLastName').value = student.last_name
            document.querySelector('#editEmail').value = student.email
            document.querySelector('#editPhone').value = student.phone
            document.querySelector('#editGender').value = student.gender
        }

        //edit student record
        document.querySelector('#editStudentForm').addEventListener('submit', async function (e) {
            e.preventDefault()
            const id = document.querySelector('#studentId').value
            const formData = new FormData(this)
            console.log(id)
            const res = await fetch(`${apiUrl}/${id}`, {
                method: 'PUT',
                headers:{'Authorization':`Bearer ${token}`},
                body: formData
            })

            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('edit-student-modal')).hide()
                fetchStudents()
            } else {
                alert('Error to creating student.')
            }
        })

        //delete student record
        async function deleteStudent(id) {
            if (confirm('Are you sure, you want to delete?')) {
                await fetch(`${apiUrl}/${id}`, { method: 'DELETE',headers:{'Authorization':`Bearer ${token}`}})
                fetchStudents()
            }
        }
        //logout 
        function logout(){
            if(confirm('Are you sure, you want to log out.')){
                localStorage.removeItem('token')
                window.location.href='index.html'
            }
        }
    </script>
</body>

</html>